<% content_for :title, "#{@postal_code.postal_code} - #{@postal_code.name_en} | #{t('site.name')}" %>

<% content_for :head do %>
  <meta name="description" content="<%= t('postal_code.meta_description', code: @postal_code.postal_code, name: @postal_code.name_en, type: t("location_type.#{@postal_code.location_type}")) %>">
  <meta property="og:title" content="<%= @postal_code.postal_code %> - <%= @postal_code.name_en %> | <%= t('site.name') %>">
  <meta property="og:description" content="<%= t('postal_code.meta_description', code: @postal_code.postal_code, name: @postal_code.name_en, type: t("location_type.#{@postal_code.location_type}")) %>">
  <link rel="canonical" href="<%= postal_code_url(@postal_code.postal_code) %>">
<% end %>

<% content_for :structured_data do %>
  <!-- BreadcrumbList Schema -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      {
        "@type": "ListItem",
        "position": 1,
        "name": "<%= t('breadcrumb.home') %>",
        "item": "https://cam-postal.gotabs.net/"
      },
      {
        "@type": "ListItem",
        "position": 2,
        "name": "<%= t('breadcrumb.provinces') %>",
        "item": "https://cam-postal.gotabs.net/provinces"
      }<% if @postal_code.province %>,
      {
        "@type": "ListItem",
        "position": 3,
        "name": "<%= @postal_code.province.name_en %>",
        "item": "https://cam-postal.gotabs.net/provinces/<%= @postal_code.province.name_en.parameterize %>"
      }<% end %><% if @postal_code.district? || @postal_code.commune? %><% if @postal_code.district %>,
      {
        "@type": "ListItem",
        "position": <%= @postal_code.commune? ? 4 : 4 %>,
        "name": "<%= @postal_code.commune? ? @postal_code.district.name_en : @postal_code.name_en %>",
        "item": "https://cam-postal.gotabs.net/provinces/<%= @postal_code.province&.name_en&.parameterize %>/<%= (@postal_code.commune? ? @postal_code.district : @postal_code).name_en.parameterize %>"
      }<% end %><% end %><% if @postal_code.commune? %>,
      {
        "@type": "ListItem",
        "position": 5,
        "name": "<%= @postal_code.name_en %>",
        "item": "<%= postal_code_url(@postal_code.postal_code) %>"
      }<% end %>
    ]
  }
  </script>

  <!-- Place/AdministrativeArea Schema -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "AdministrativeArea",
    "name": "<%= @postal_code.name_en %>",
    <% if @postal_code.name_km.present? %>"alternateName": "<%= @postal_code.name_km %>",<% end %>
    "address": {
      "@type": "PostalAddress",
      "postalCode": "<%= @postal_code.postal_code %>",
      "addressLocality": "<%= @postal_code.name_en %>",
      <% if @postal_code.district && !@postal_code.district? %>"addressRegion": "<%= @postal_code.district.name_en %>",<% end %>
      "addressCountry": {
        "@type": "Country",
        "name": "Cambodia",
        "alternateName": "កម្ពុជា"
      }
    },
    "containedInPlace": {
      "@type": "Country",
      "name": "Cambodia",
      "alternateName": "ព្រះរាជាណាចក្រកម្ពុជា"
    }
  }
  </script>
<% end %>

<div class="show-page">
  <!-- Breadcrumb Navigation -->
  <nav class="breadcrumb" aria-label="Breadcrumb">
    <ol>
      <li><a href="<%= root_path %>"><%= t('breadcrumb.home') %></a></li>
      <li><a href="<%= provinces_path %>"><%= t('breadcrumb.provinces') %></a></li>
      <% if @postal_code.province %>
        <li><a href="<%= province_path(@postal_code.province.name_en.parameterize) %>"><%= @postal_code.province.name_en %></a></li>
      <% end %>
      <% if @postal_code.commune? && @postal_code.district %>
        <li><a href="<%= province_district_path(@postal_code.province.name_en.parameterize, @postal_code.district.name_en.parameterize) %>"><%= @postal_code.district.name_en %></a></li>
      <% end %>
      <li aria-current="page"><%= @postal_code.name_en %></li>
    </ol>
  </nav>

  <div class="results-section">
    <div class="results-list">
      <div class="result-card <%= @postal_code.location_type %>"
           data-controller="copy"
           data-copy-text-value="<%= @postal_code.postal_code %>"
           data-action="click->copy#copy">
        <div class="result-header">
          <span class="postal-code"><%= @postal_code.postal_code %></span>
          <span class="location-type <%= @postal_code.location_type %>"><%= t("location_type.#{@postal_code.location_type}") %></span>
        </div>
        <div class="result-body">
          <h1 class="name-en"><%= @postal_code.name_en %></h1>
          <% if @postal_code.name_km.present? %>
            <p class="name-km"><%= @postal_code.name_km %></p>
          <% end %>
          <% if @postal_code.parent_location.present? %>
            <p class="parent-location"><%= @postal_code.parent_location %></p>
          <% end %>
        </div>
        <span class="copy-hint"><%= t('home.click_to_copy') %></span>
      </div>
    </div>

    <!-- Time Capsules Section -->
    <div class="time-capsules-section">
      <div class="capsules-header">
        <h2><%= t('time_capsules.title') %></h2>
        <p class="capsules-subtitle"><%= t('time_capsules.subtitle') %></p>
      </div>

      <% if @time_capsules.any? %>
        <div class="capsules-count-wrapper">
          <span id="capsules-count"><%= render partial: "time_capsules/count", locals: { count: @time_capsules.size } %></span>
        </div>
        <div id="capsules-list" class="capsules-list">
          <%= render partial: "time_capsules/capsule", collection: @time_capsules, as: :capsule %>
        </div>
      <% else %>
        <div id="capsules-list" class="capsules-list">
          <p class="no-capsules"><%= t('time_capsules.empty') %></p>
        </div>
      <% end %>

      <div id="capsule-form" class="capsule-form-wrapper">
        <%= render partial: "time_capsules/form", locals: { postal_code: @postal_code, time_capsule: @new_capsule } %>
      </div>
    </div>

    <!-- Related postal codes section -->
    <% if @related_codes&.any? %>
      <div class="related-section">
        <% parent = @postal_code.commune? ? @postal_code.district : @postal_code.province %>
        <h2><%= t('postal_code.related_title', area: parent&.name_en) %></h2>
        <div class="related-list">
          <% @related_codes.first(6).each do |related| %>
            <a href="<%= postal_code_path(related.postal_code) %>" class="related-link">
              <span class="related-code"><%= related.postal_code %></span>
              <span class="related-name"><%= related.name_en %></span>
            </a>
          <% end %>
        </div>
        <% if parent %>
          <a href="<%= @postal_code.commune? ? province_district_path(@postal_code.province.name_en.parameterize, @postal_code.district.name_en.parameterize) : province_path(@postal_code.province.name_en.parameterize) %>" class="view-all-link">
            <%= t('postal_code.view_all', area: parent.name_en) %> →
          </a>
        <% end %>
      </div>
    <% end %>

    <div class="unity-slogan">
      <p class="slogan-km"><%= t('slogan.km') %></p>
      <p class="slogan-en"><%= t('slogan.en') %></p>
    </div>
  </div>
</div>
